!function(){var e,t,n,a,r,i,o={2805:function(e,t,n){"use strict";let a;n(4090);var r=n(8091);n(6639);let i={"2024/04/03.1":14,"2024/04/10":16,"2024/04/20":17,"2024/04/20.1":18,"2024/05/05":21,"2024/05/08":22,"2024/05/08.1":23,"2024/05/09":24,"2024/05/10":26,"2024/05/10.1":28};class o extends r.ZP{constructor(){super("twitch-comments"),this.version(i["2024/05/10.1"]).stores({users:"id,*userId,displayName,type,broadcasterType",actions:"++autoincrementId,id,*channel,messageType,*userId,*timestamp,[channel+timestamp]",followers:"++id,channelId,userId,[channelId+userId],createdAt,[channelId+createdAt]",channelHistories:"++id,channelId,type,categoryId,timestamp,[channelId+timestamp]",listenerHistories:"++id,channelId,userId,[channelId+timestamp]",games:"id,igdb_id,name",broadcastTemplates:"++id,channelId,gameId,*tags,favorite",settings:"id"})}}let s=new o;(async()=>(console.log("migration"),s.version(i["2024/05/10.1"]).upgrade(e=>e.table("followers").clear()),!0))().then(()=>{console.log("migrated")});let d=e=>{let t={method:"websocket",session_id:e};return{stream:{online:e=>({type:"stream.online",version:"1",condition:{broadcaster_user_id:e},transport:t}),ofline:e=>({type:"stream.offline",version:"1",condition:{broadcaster_user_id:e},transport:t})},channel:{update:e=>({type:"channel.update",version:"2",condition:{broadcaster_user_id:e},transport:t}),chat:{message:(e,n)=>({type:"channel.chat.message",version:"1",condition:{broadcaster_user_id:e,user_id:n},transport:t}),notification:(e,n)=>({type:"channel.chat.notification",version:"1",condition:{broadcaster_user_id:e,user_id:n},transport:t})},channel_points_automatic_reward:{add:e=>({type:"channel.channel_points_automatic_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e},transport:t})},channel_points_custom_reward:{add:e=>({type:"channel.channel_points_custom_reward.add",version:"1",condition:{broadcaster_user_id:e},transport:t})},points_custom_reward_redemption:{add:(e,n)=>({type:"channel.channel_points_custom_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e,rewardId:n},transport:t})},channel_points_automatic_reward_redemption:{add:e=>({type:"channel.channel_points_automatic_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e},transport:t})}}}};var c=n(3666);let l={USER:{METHOD:"GET",ENDPOINT:"https://api.twitch.tv/helix/users"},EVENTSUB:{SUBSCRIPTIONS:{METHOD:"POST",ENDPOINT:"https://api.twitch.tv/helix/eventsub/subscriptions"}}},u=async(e,t)=>{let n=y(await p()),a=async n=>{if(!n.ok){let a=await n.json();throw Error("fetch error\n    ".concat(JSON.stringify({status:n.status,endpoint:e.ENDPOINT,params:t,response:a})))}},r=async()=>"GET"===e.METHOD?await n("".concat(e.ENDPOINT,"?").concat(c.Z.stringify(t)),{method:e.METHOD}):await n(e.ENDPOINT,{method:e.METHOD,body:JSON.stringify(t)}),i=await r();return a(i),await i.json().catch(()=>{})},p=async()=>{let e=await s.settings.get("twitch_token");if(null==e)throw Error("twitch token is not found");return e.value},m=async e=>await u(l.USER,e),_=async()=>await m({}),h=async e=>await u(l.EVENTSUB.SUBSCRIPTIONS,e),y=e=>{let t={Authorization:"Bearer ".concat(e),"Client-Id":"of40zatnkd1ftcaqnf92ahqznkg1vn","Content-Type":"application/json"};return function(){for(var e=arguments.length,n=Array(e),a=0;a<e;a++)n[a]=arguments[a];let[r,i,...o]=n;return fetch(r,{...i,headers:{...t,...(null==i?void 0:i.headers)||{}}},...o)}},f=e=>(e<=0&&console.warn("keepalive timeout secondsは0以上の値である必要があります。"),e>=600&&console.warn("keepalive timeout secondsは600以下の値である必要があります。"),"".concat("wss://eventsub.wss.twitch.tv/ws","?keepalive_timeout_seconds=").concat(e)),w=e=>(t,n)=>{let a=e=>{let a=JSON.parse(e.data);t===a.metadata.message_type&&n(a,e)};return e.addEventListener("message",a),a},v=e=>t=>{e.removeEventListener("message",t)},g=e=>(t,n)=>{let a=e=>{let a=JSON.parse(e.data);"notification"===a.metadata.message_type&&a.metadata.subscription_type===t&&n(a,e)};return e.addEventListener("message",a),a};(a=null,{connect:async()=>{let e=new WebSocket(f(30)),t=g(e),n=w(e),r=v(e);a=e;let i=(await _()).data[0];(async()=>{let e=await new Promise(e=>{let t=n("session_welcome",function(n){r(t),e(n.payload.session.id)})}),t=i.id,a=d(e);await Promise.all([h(a.channel.chat.message(t,t)),h(a.channel.update(t)),h(a.stream.online(t)),h(a.stream.ofline(t)),h(a.channel.channel_points_automatic_reward_redemption.add(t)),h(a.channel.channel_points_custom_reward.add(t)),h(a.channel.points_custom_reward_redemption.add(t))])})(),e.addEventListener("message",e=>{console.log(JSON.parse(e.data))}),t("channel.chat.message",e=>{s.actions.add({id:e.payload.event.message_id,userId:e.payload.event.chatter_user_id,channel:i.login,message:e.payload.event.message.text,messageType:"chat",fragments:e.payload.event.message.fragments,timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.channel_points_automatic_reward_redemption.add",e=>{s.actions.add({id:e.payload.event.id,userId:e.payload.event.user_id,channel:i.login,userTitle:e.payload.event.reward.type,userInput:e.payload.event.user_input,rewardId:e.payload.event.reward.type,messageType:"atutomatic-reward",timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.channel_points_custom_reward_redemption.add",e=>{s.actions.add({id:e.payload.event.id,userId:e.payload.event.user_id,channel:i.login,userTitle:e.payload.event.reward.title,userInput:e.payload.event.user_input,rewardId:e.payload.event.reward.id,messageType:"reward",timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.update",e=>{s.channelHistories.put({channelId:i.login,type:"update",broadcastTitle:e.payload.event.title,categoryId:e.payload.event.category_id,categoryName:e.payload.event.category_name,language:e.payload.event.language,timestamp:new Date,rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})})},close:()=>{null!=a&&(a.close(),a=null)}}).connect()}},s={};function d(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}},a=!0;try{o[e](n,n.exports,d),a=!1}finally{a&&delete s[e]}return n.exports}d.m=o,d.x=function(){var e=d.O(void 0,[251,639],function(){return d(2805)});return d.O(e)},e=[],d.O=function(t,n,a,r){if(n){r=r||0;for(var i=e.length;i>0&&e[i-1][2]>r;i--)e[i]=e[i-1];e[i]=[n,a,r];return}for(var o=1/0,i=0;i<e.length;i++){for(var n=e[i][0],a=e[i][1],r=e[i][2],s=!0,c=0;c<n.length;c++)o>=r&&Object.keys(d.O).every(function(e){return d.O[e](n[c])})?n.splice(c--,1):(s=!1,r<o&&(o=r));if(s){e.splice(i--,1);var l=a();void 0!==l&&(t=l)}}return t},d.d=function(e,t){for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},d.f={},d.e=function(e){return Promise.all(Object.keys(d.f).reduce(function(t,n){return d.f[n](e,t),t},[]))},d.u=function(e){return 251===e?"static/chunks/251-d704d2b0098c8e88.js":"static/chunks/"+e+".d0a344457b60f6d9.js"},d.miniCssF=function(e){},d.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},d.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},d.tt=function(){return void 0===t&&(t={createScriptURL:function(e){return e}},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(t=trustedTypes.createPolicy("nextjs#bundler",t))),t},d.tu=function(e){return d.tt().createScriptURL(e)},d.p="/twitch-comment-viewer-v1-frontend/_next/",n={805:1},d.f.i=function(e,t){n[e]||importScripts(d.tu(d.p+d.u(e)))},r=(a=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(a),a.push=function(e){var t=e[0],a=e[1],i=e[2];for(var o in a)d.o(a,o)&&(d.m[o]=a[o]);for(i&&i(d);t.length;)n[t.pop()]=1;r(e)},i=d.x,d.x=function(){return Promise.all([d.e(251),d.e(639)]).then(i)},_N_E=d.x()}();