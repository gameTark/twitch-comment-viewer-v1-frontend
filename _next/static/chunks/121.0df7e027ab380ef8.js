!function(){var e,t,a,n,r,i,o={29121:function(e,t,a){"use strict";let n;a(2265);var r=a(59772);let i=r.Ry({createdAt:r.hT().optional().default(new Date),updateAt:r.hT().optional().default(new Date),deletedAt:r.hT().optional()}),o=r.Z_();r.Ry({id:o,displayName:r.Z_(),login:r.Z_(),type:r.Z_(),broadcasterType:r.Z_(),description:r.Z_(),profileImageUrl:r.Z_().url(),offlineImageUrl:r.Z_().url(),metaComment:r.Z_(),isSpam:r.O7().optional().default(!1),rowData:r.Z_().optional()}).and(i);let s=r.Ry({user_id:o,user_login:r.Z_(),user_name:r.Z_()}),d=r.Ry({prefix:r.Z_(),bits:r.Rx(),tier:r.Rx()}),l=r.Ry({id:r.Z_(),emote_set_id:r.Z_(),owner_id:r.Z_(),format:r.Z_().array()}),c=r.Ry({type:r.Km(["text"]),text:r.Z_(),cheermote:d.optional(),emote:r.lB(),mention:r.lB()}),u=r.Ry({type:r.Km(["mention"]),text:r.Z_(),cheermote:d.optional(),emote:r.lB(),mention:s}),p=r.Ry({type:r.Km(["emote"]),text:r.Z_(),cheermote:d.optional(),emote:l,mention:r.lB()}),m=c.or(u).or(p),_=r.Ry({autoincrementId:r.Rx().optional(),id:r.Z_(),channel:r.Z_(),userId:o.nullable().default(null),timestamp:r.Rx().optional(),bits:r.Z_().optional(),rowdata:r.Z_().optional()}).and(i),y=r.Ry({messageType:r.Km(["chat"]),message:r.Z_(),fragments:m.array()}).and(_),h=r.Ry({messageType:r.Km(["reward","atutomatic-reward"]),rewardId:r.Z_(),userTitle:r.Z_(),userInput:r.Z_()}).and(_);y.or(h),r.Ry({id:r.Rx().optional(),channelId:r.Z_().optional(),gameId:r.Z_().optional(),broadcastTitle:r.Z_().max(140,"最大140文字まで入力可能です。").default(""),language:r.Z_(),tags:r.IX(r.Z_()).max(25,"最大のタグ数は25件までです。").default([]),classificationLabels:r.Z_().array().default([]),isBrandedContent:r.O7().default(!1),favorite:r.O7().optional().default(!1)}).and(i),r.Ry({id:r.Z_(),name:r.Z_(),box_art_url:r.Z_().url(),igdb_id:r.Z_()}).and(i);var w=a(33427);a(91279);class f extends w.ZP{async getMe(){let e=await this.parameters.get("me");return(null==e?void 0:e.type)!=="me"?null:e.value||null}async getLive(){let e=await this.parameters.get("live");return(null==e?void 0:e.type)!=="live"?null:e.value||null}async getChatters(){let e=await this.parameters.get("chatters");return(null==e?void 0:e.type)!=="chatters"?null:e.value||null}constructor(){super("twitch-comments"),this.version(30).stores({users:"id,*userId,displayName,type,broadcasterType",games:"id,igdb_id,name",actions:"++autoincrementId,id,*channel,messageType,*userId,*timestamp,[channel+timestamp]",followers:"++id,channelId,userId,[channelId+userId],createdAt,[channelId+createdAt]",channelHistories:"++id,channelId,type,categoryId,timestamp,[channelId+timestamp]",listenerHistories:"++id,channelId,userId,[channelId+timestamp]",broadcastTemplates:"++id,channelId,gameId,*tags,favorite",parameters:"type",spam:"login",settings:"id"})}}let v=new f;var g=a(62737),I=a.n(g);a(39055);var b=a(90748),T=a.n(b),O=a(86688),D=a.n(O),Z=a(51470),x=a.n(Z);I().extend(D()),I().extend(x()),I().extend(T()),I().locale("ja");let N=I(),E=e=>{let t={method:"websocket",session_id:e};return{stream:{online:e=>({type:"stream.online",version:"1",condition:{broadcaster_user_id:e},transport:t}),ofline:e=>({type:"stream.offline",version:"1",condition:{broadcaster_user_id:e},transport:t})},channel:{update:e=>({type:"channel.update",version:"2",condition:{broadcaster_user_id:e},transport:t}),chat:{message:(e,a)=>({type:"channel.chat.message",version:"1",condition:{broadcaster_user_id:e,user_id:a},transport:t}),notification:(e,a)=>({type:"channel.chat.notification",version:"1",condition:{broadcaster_user_id:e,user_id:a},transport:t})},channel_points_automatic_reward:{add:e=>({type:"channel.channel_points_automatic_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e},transport:t})},channel_points_custom_reward:{add:e=>({type:"channel.channel_points_custom_reward.add",version:"1",condition:{broadcaster_user_id:e},transport:t})},points_custom_reward_redemption:{add:(e,a)=>({type:"channel.channel_points_custom_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e,rewardId:a},transport:t})},channel_points_automatic_reward_redemption:{add:e=>({type:"channel.channel_points_automatic_reward_redemption.add",version:"1",condition:{broadcaster_user_id:e},transport:t})}}}};var A=a(12491);let P={METHOD:"GET",ENDPOINT:"https://api.twitch.tv/helix/users"},S={METHOD:"GET",ENDPOINT:"https://api.twitch.tv/helix/chat/chatters"},k={METHOD:"GET",ENDPOINT:"https://api.twitch.tv/helix/channels/followers"},R={METHOD:"GET",ENDPOINT:"https://api.twitch.tv/helix/streams"},j={METHOD:"POST",ENDPOINT:"https://api.twitch.tv/helix/eventsub/subscriptions"},M=async(e,t)=>{let a=U(await H()),n=async a=>{if(!a.ok){let n=await a.json();throw Error("fetch error\n    ".concat(JSON.stringify({status:a.status,endpoint:e.ENDPOINT,params:t,response:n})))}},r=async()=>"GET"===e.METHOD?await a("".concat(e.ENDPOINT,"?").concat(A.Z.stringify(t)),{method:e.METHOD}):await a(e.ENDPOINT,{method:e.METHOD,body:JSON.stringify(t)}),i=await r();return n(i),await i.json().catch(()=>{})},H=async()=>{let e=await v.settings.get("twitch_token");if(null==e)throw Error("twitch token is not found");return e.value},C=async e=>await M(R,e),J=async e=>await M(k,e),L=async e=>await M(S,e),B=async e=>await M(P,e),G=async()=>await B({}),K=async e=>await M(j,e),U=e=>{let t={Authorization:"Bearer ".concat(e),"Client-Id":"of40zatnkd1ftcaqnf92ahqznkg1vn","Content-Type":"application/json"};return function(){for(var e=arguments.length,a=Array(e),n=0;n<e;n++)a[n]=arguments[n];let[r,i,...o]=a;return fetch(r,{...i,headers:{...t,...(null==i?void 0:i.headers)||{}}},...o)}},q=e=>null==e.deletedAt,z=async()=>{let e=await v.getMe();if(null==e){let e=(await G()).data[0],t={id:e.id,login:e.login};return await v.parameters.put({type:"me",value:t}),t}return e},F=async()=>{try{let e=await fetch("https://api.twitchinsights.net/v1/bots/all",{method:"GET"});return await e.json()}catch(e){return{bots:[],_total:0}}},W="SPAM_UPDATED_AT",X=async()=>{let e=await v.settings.get(W);if((null==e?void 0:e.value)!=null&&N(e.value).isSameOrBefore(N(new Date).add(7,"day")))return;let t=await F();v.settings.put({id:W,value:new Date().toISOString()}),v.spam.bulkPut(t.bots.map(e=>({login:e[0]})))};X(),setInterval(()=>{X()},1e4);let Q=async()=>{let e=await z(),t=(await C({user_id:e.id})).data[0];if(null==t){v.parameters.put({type:"live",value:null});return}v.parameters.put({type:"live",value:{isLive:!0,startedAt:new Date(t.started_at),viewCount:t.viewer_count}})};Q(),setInterval(()=>{Q()},1e4);let V=async()=>{let e=await z();if(null==e)return;let t=await L({broadcaster_id:e.id,moderator_id:e.id});t.data.sort((e,t)=>Number(e.user_id)-Number(t.user_id));let a=(await v.spam.bulkGet(t.data.map(e=>e.user_login))).map(e=>null==e?void 0:e.login);v.parameters.put({type:"chatters",value:{users:t.data.filter(e=>!a.includes(e.user_login)).map(e=>e.user_id),total:t.total-a.length}})};V(),setInterval(()=>{V()},1e4);let Y=async e=>(await v.followers.where("channelId").equals(e).sortBy("followedAt")).reverse().filter(q).filter(e=>null==e.deletedAt),$=async()=>{let e=await z(),t=await Y(e.id),a=await J({broadcaster_id:e.id,first:"100"}).then(t=>t.data.map(t=>({channelId:e.id,userId:t.user_id,followedAt:new Date(t.followed_at),updateAt:new Date,createdAt:new Date}))),n=a.filter(e=>null==t.find(t=>t.userId===e.userId&&t.channelId===e.channelId)),r=t.filter(e=>null==a.find(t=>t.userId===e.userId&&t.channelId===e.channelId)).map(e=>({...e,deletedAt:new Date}));(0!==n.length||0!==r.length)&&await Promise.all([v.followers.bulkAdd(n),v.followers.bulkPut(r)])};$(),setInterval(()=>{$()},1e4);let ee=e=>(e<=0&&console.warn("keepalive timeout secondsは0以上の値である必要があります。"),e>=600&&console.warn("keepalive timeout secondsは600以下の値である必要があります。"),"".concat("wss://eventsub.wss.twitch.tv/ws","?keepalive_timeout_seconds=").concat(e)),et=e=>(t,a)=>{let n=e=>{let n=JSON.parse(e.data);t===n.metadata.message_type&&a(n,e)};return e.addEventListener("message",n),n},ea=e=>t=>{e.removeEventListener("message",t)},en=e=>(t,a)=>{let n=e=>{let n=JSON.parse(e.data);"notification"===n.metadata.message_type&&n.metadata.subscription_type===t&&a(n,e)};return e.addEventListener("message",n),n};(n=null,{connect:async()=>{let e=new WebSocket(ee(30)),t=en(e),a=et(e),r=ea(e);n=e;let i=await z();(async()=>{let e=E(await new Promise(e=>{let t=a("session_welcome",function(a){r(t),e(a.payload.session.id)})}));await Promise.all([K(e.channel.chat.message(i.id,i.id)),K(e.channel.update(i.id)),K(e.stream.online(i.id)),K(e.stream.ofline(i.id)),K(e.channel.channel_points_automatic_reward_redemption.add(i.id)),K(e.channel.channel_points_custom_reward.add(i.id)),K(e.channel.points_custom_reward_redemption.add(i.id))])})(),e.addEventListener("message",e=>{console.log(JSON.parse(e.data))}),t("channel.chat.message",e=>{v.actions.add({id:e.payload.event.message_id,userId:e.payload.event.chatter_user_id,channel:i.login,message:e.payload.event.message.text,messageType:"chat",fragments:e.payload.event.message.fragments,timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.channel_points_automatic_reward_redemption.add",e=>{v.actions.add({id:e.payload.event.id,userId:e.payload.event.user_id,channel:i.login,userTitle:e.payload.event.reward.type,userInput:e.payload.event.user_input,rewardId:e.payload.event.reward.type,messageType:"atutomatic-reward",timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.channel_points_custom_reward_redemption.add",e=>{v.actions.add({id:e.payload.event.id,userId:e.payload.event.user_id,channel:i.login,userTitle:e.payload.event.reward.title,userInput:e.payload.event.user_input,rewardId:e.payload.event.reward.id,messageType:"reward",timestamp:Date.now(),rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})}),t("channel.update",e=>{v.channelHistories.put({channelId:i.login,type:"update",broadcastTitle:e.payload.event.title,categoryId:e.payload.event.category_id,categoryName:e.payload.event.category_name,language:e.payload.event.language,timestamp:new Date,rowdata:JSON.stringify(e),updateAt:new Date,createdAt:new Date})})},close:()=>{null!=n&&(n.close(),n=null)}}).connect()}},s={};function d(e){var t=s[e];if(void 0!==t)return t.exports;var a=s[e]={exports:{}},n=!0;try{o[e].call(a.exports,a,a.exports,d),n=!1}finally{n&&delete s[e]}return a.exports}d.m=o,d.x=function(){var e=d.O(void 0,[772,425,279],function(){return d(29121)});return d.O(e)},e=[],d.O=function(t,a,n,r){if(a){r=r||0;for(var i=e.length;i>0&&e[i-1][2]>r;i--)e[i]=e[i-1];e[i]=[a,n,r];return}for(var o=1/0,i=0;i<e.length;i++){for(var a=e[i][0],n=e[i][1],r=e[i][2],s=!0,l=0;l<a.length;l++)o>=r&&Object.keys(d.O).every(function(e){return d.O[e](a[l])})?a.splice(l--,1):(s=!1,r<o&&(o=r));if(s){e.splice(i--,1);var c=n();void 0!==c&&(t=c)}}return t},d.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return d.d(t,{a:t}),t},d.d=function(e,t){for(var a in t)d.o(t,a)&&!d.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},d.f={},d.e=function(e){return Promise.all(Object.keys(d.f).reduce(function(t,a){return d.f[a](e,t),t},[]))},d.u=function(e){return 279===e?"static/chunks/279.c2a93a3b8476764f.js":"static/chunks/"+e+"-"+({425:"753845a9051cbe25",772:"208b2e559d5c86c4"})[e]+".js"},d.miniCssF=function(e){},d.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},d.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},d.tt=function(){return void 0===t&&(t={createScriptURL:function(e){return e}},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(t=trustedTypes.createPolicy("nextjs#bundler",t))),t},d.tu=function(e){return d.tt().createScriptURL(e)},d.p="/twitch-comment-viewer-v1-frontend/_next/",a={121:1},d.f.i=function(e,t){a[e]||importScripts(d.tu(d.p+d.u(e)))},r=(n=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(n),n.push=function(e){var t=e[0],n=e[1],i=e[2];for(var o in n)d.o(n,o)&&(d.m[o]=n[o]);for(i&&i(d);t.length;)a[t.pop()]=1;r(e)},i=d.x,d.x=function(){return Promise.all([772,425,279].map(d.e,d)).then(i)},_N_E=d.x()}();